@using System.Text.Json
@using DaimlerConfig.Components.Models
@using Microsoft.Extensions.FileProviders
@inject ISnackbar Snackbar
@code {
    private const string SELECTED_LANGUAGE_KEY = "SelectedLanguage";
    public string SelectedLanguage = "";
    public List<string> AvailableLanguages = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            SetSelectedLang();
            await SaveLanguageSettings(SelectedLanguage);
            SetAvailableLanguages();
        }
        catch (Exception) { }
    }

    public void SetAvailableLanguages()
    {
        var fileProvider = new PhysicalFileProvider(Path.Combine(GetLanguagesFolderPath()));
        AvailableLanguages = fileProvider.GetDirectoryContents("")
            .Where(f => f.Name.EndsWith("LANG.json"))
            .Select(f => Path.GetFileNameWithoutExtension(f.Name))
            .ToList();
    }

    public void SetSelectedLang()
    {
        SelectedLanguage = Preferences.Default.Get(SELECTED_LANGUAGE_KEY, SelectedLanguage);
    }

    public async Task SaveLanguageSettings(string selectedLang)
    {
        Preferences.Default.Set(SELECTED_LANGUAGE_KEY, selectedLang);
        await LoadSelectedLanguage( selectedLang);
    }

    private async Task LoadSelectedLanguage(string selectedLang)
    {
        var languageFilePath = Path.Combine(GetLanguagesFolderPath(), $"{selectedLang}.json");
        await LoadLanguageFromFileAsync(languageFilePath);
        Snackbar.Add( "breakpoint 1",Severity.Success);
    }

    public string GetLanguagesFolderPath()
    {
        var appDataPath = Environment.GetFolderPath(Environment.SpecialFolder.UserProfile);
        return Path.Combine(appDataPath);
    }

    public void OnLanguageChanged(string newLanguage)
    { 
        SelectedLanguage = newLanguage;
    }

    private async Task LoadLanguageFromFileAsync(string filePath)
    {
        if (!File.Exists(filePath))
            throw new FileNotFoundException($"Sprachdatei nicht gefunden: {filePath}");

        var jsonContent = await File.ReadAllTextAsync(filePath);
        Language.SetLanguage(LoadLanguageFromJson(jsonContent));
        Snackbar.Add( "breakpoint 3",Severity.Success);
    }

    private LanguageHelper LoadLanguageFromJson(string jsonContent)
    {
        var options = new JsonSerializerOptions
        {
            PropertyNameCaseInsensitive = true,
            PropertyNamingPolicy = JsonNamingPolicy.CamelCase
        };
        Snackbar.Add( "breakpoint 5",Severity.Success);
        return JsonSerializer.Deserialize<LanguageHelper>(jsonContent, options) ?? new LanguageHelper();
    }
}
